version: 2
deploy:
  steps:
    terraformInit:
      after: 
        - name: VPN installation
          run: |
            echo "Installing OpenVPN"
            sudo apk update
            sudo apk add openvpn btrfs-progs e2fsprogs e2fsprogs-extra ip6tables iptables openssl shadow-uidmap xfsprogs xz openrc kmod linux-vanilla
            sudo apk add --update coreutils
            apk info -vv | grep -e '^linux-vanilla' | awk '{print $1}' | xargs -I{} sh -c 'apk fetch --quiet --stdout {} | tar -xz -C /lib/modules'
            sudo ln -s /path/to/module.ko /lib/modules/`uname -r`
            sudo depmod -a
            sudo modprobe module
            sudo modprobe tun
            echo $OPENVPN_CONFIG_FILE | base64 --decode > ~/config.ovpn
            echo "Connecting"
            openvpn --config ~/config.ovpn
            sleep 10
            nslookup rancher.dev 169.254.169.253